# Simplified btrbk configuration with local encrypted disk and NFS targets

# Logging and locking
transaction_log            /var/log/btrbk.log
lockfile                   /run/lock/btrbk.lock

# Use sudo for btrfs commands
backend_local_user         btrfs-progs-sudo

# Performance settings optimized for 2.5G LAN
# Local buffer (sender side) - using mbuffer if available (version 20180505+)
stream_buffer              1g
# Remote buffer (receiver side) - adds buffering on px-nas.lan  
stream_buffer_remote       1g
# DISABLED: Eliminates double compression (filesystem already uses zstd:1)
# Source filesystem compression is sufficient for LAN transfers
stream_compress            no
ssh_compression            no

# Timestamp format
timestamp_format           long

# Create snapshots only when changes detected
snapshot_create            onchange

# Use incremental backups to maintain chain from base
# The retention policy will create a sparse chain
incremental                yes

# Local snapshot retention (minimal for laptop space)
snapshot_preserve_min      latest
snapshot_preserve          7d

# Default target retention for local encrypted disk (shorter)
target_preserve_min        latest  
target_preserve           7d 4w

# Archive retention for NFS (longer retention)
archive_preserve_min       latest
archive_preserve           7d 4w 12m *y

# SSH configuration for network backup
ssh_identity     /etc/btrbk/ssh/id_rsa
ssh_user         root
backend_remote   btrfs-progs-sudo

# Main volume configuration
# NOTE: Backup targets (USB, SSH) are in separate configs to decouple
# snapshot management from backup target availability
volume /mnt/btr_pool
  snapshot_dir     btrbk_snapshots

  # Subvolumes to snapshot
  subvolume   @root
  subvolume   @home
